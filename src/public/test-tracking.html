<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClickBlock Tracking Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .container {
      background: #1e293b;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid #334155;
    }
    h1 {
      color: #60a5fa;
      margin-bottom: 10px;
    }
    .info {
      background: #1e3a8a;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #3b82f6;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      background: #0f172a;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    input {
      background: #1e293b;
      border: 1px solid #475569;
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      width: 300px;
      margin: 10px 0;
    }
    .log {
      background: #0f172a;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      border: 1px solid #334155;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info-text { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç ClickBlock Tracking Test Page</h1>
    <p>Use this page to test your tracking snippet installation.</p>
    
    <div class="info">
      <strong>Instructions:</strong>
      <ol>
        <li>Copy your tracking snippet from the dashboard</li>
        <li>Paste it in the &lt;head&gt; section below</li>
        <li>Reload the page and check the console/logs</li>
        <li>Click the "Simulate Click" button to test tracking</li>
      </ol>
    </div>

    <div class="test-section">
      <h2>Test Tracking</h2>
      <div>
        <label>
          <strong>Snippet ID:</strong><br>
          <input type="text" id="snippetId" placeholder="AG-XXXXXXXX" value="AG-NGVHX0S8">
        </label>
      </div>
      <div style="margin-top: 15px;">
        <button onclick="testTrack()">Simulate Click</button>
        <button onclick="testMultipleClicks()">Simulate 5 Clicks</button>
        <button onclick="clearLog()">Clear Log</button>
      </div>
    </div>

    <div class="test-section">
      <h2>Console Log</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- Paste your tracking snippet here -->
  <!-- Example:
  <script>
    (function() {
      var ag = document.createElement('script');
      ag.type = 'text/javascript';
      ag.async = true;
      ag.src = '/tracking.js';
      ag.setAttribute('data-snippet-id', 'AG-NGVHX0S8');
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ag, s);
    })();
  </script>
  -->
  
  <script>
    const log = document.getElementById('log');
    
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      log.innerHTML = '';
    }

    // Intercept console.log to show in UI
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      if (args[0] && args[0].includes && args[0].includes('ClickBlock')) {
        addLog(args.join(' '), 'success');
      }
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      if (args[0] && args[0].includes && args[0].includes('ClickBlock')) {
        addLog(args.join(' '), 'error');
      }
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      if (args[0] && args[0].includes && args[0].includes('ClickBlock')) {
        addLog(args.join(' '), 'error');
      }
    };
    
    async function testTrack() {
      const snippetId = document.getElementById('snippetId').value;
      if (!snippetId) {
        addLog('Please enter a snippet ID', 'error');
        return;
      }

      addLog(`Testing tracking for snippet: ${snippetId}`, 'info-text');

      try {
        const response = await fetch('https://lwyzoynbpuytmtcrjbga.supabase.co/functions/v1/make-server-51144976/test-track', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXpveW5icHV5dG10Y3JqYmdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTYzMTIsImV4cCI6MjA3ODc5MjMxMn0.UHURs_eM-ZpxAZ3ADCm4BVoigW_3MjSwYkX2-Xa3MEo',
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXpveW5icHV5dG10Y3JqYmdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTYzMTIsImV4cCI6MjA3ODc5MjMxMn0.UHURs_eM-ZpxAZ3ADCm4BVoigW_3MjSwYkX2-Xa3MEo'
          },
          body: JSON.stringify({ snippetId, count: 1 })
        });

        const result = await response.json();
        if (response.ok) {
          addLog(`‚úÖ Success: ${result.message}`, 'success');
          addLog(`Total Clicks: ${result.analytics.totalClicks}, Fraud: ${result.analytics.fraudulentClicks}`, 'info-text');
        } else {
          addLog(`‚ùå Error: ${result.error}`, 'error');
        }
      } catch (error) {
        addLog(`‚ùå Network Error: ${error.message}`, 'error');
      }
    }

    async function testMultipleClicks() {
      const snippetId = document.getElementById('snippetId').value;
      if (!snippetId) {
        addLog('Please enter a snippet ID', 'error');
        return;
      }

      addLog(`Simulating 5 clicks for snippet: ${snippetId}`, 'info-text');

      for (let i = 0; i < 5; i++) {
        await testTrack();
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      addLog('‚úÖ Finished simulating 5 clicks', 'success');
    }

    // Check if tracking script is loaded
    window.addEventListener('load', function() {
      setTimeout(() => {
        const scripts = document.querySelectorAll('script[data-snippet-id]');
        if (scripts.length > 0) {
          addLog(`‚úÖ Found ${scripts.length} tracking script(s)`, 'success');
          scripts.forEach((script, index) => {
            addLog(`Script ${index + 1}: ${script.getAttribute('data-snippet-id')}`, 'info-text');
          });
        } else {
          addLog('‚ö†Ô∏è No tracking scripts found. Please install the tracking snippet.', 'error');
        }
      }, 1000);
    });
  </script>
</body>
</html>
